version: "2.2"

networks:
  master_socialvoid:
    external: false
    ipam:
      config:
        - subnet: 172.16.57.0/24

services:

  socialvoid:
    image: socialvoid:dockerfile
    container_name: socialvoid
    restart: always
    hostname: socialvoid
    networks:
      - master_socialvoid
    depends_on:
      gearman:
        condition: "service_started"
      redis:
        condition: "service_started"
      mysql_master:
        condition: "service_healthy"
      mysql_slave:
        condition: "service_healthy"
      telegram_bot_api:
        condition: "service_started"
    volumes:
      - /var/socialvoid/config/acm:/etc/acm
      - /var/socialvoid/lib:/var/socialvoid/lib
      - /var/socialvoid/legal:/var/socialvoid/legal
      - /var/socialvoid/avatars:/var/socialvoid/avatars
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro

  rpc_server:
    image: socialvoid_rpc:dockerfile
    container_name: socialvoid_rpc
    restart: always
    hostname: socialvoid_rpc
    networks:
      - master_socialvoid
    depends_on:
      gearman:
        condition: "service_started"
      redis:
        condition: "service_started"
      mysql_master:
        condition: "service_healthy"
      mysql_slave:
        condition: "service_healthy"
      telegram_bot_api:
        condition: "service_started"
      socialvoid:
        condition: "service_started"
    volumes:
      - /var/socialvoid/config/acm:/etc/acm
      - /var/socialvoid/lib:/var/socialvoid/lib
      - /var/socialvoid/legal:/var/socialvoid/legal
      - /var/socialvoid/avatars:/var/socialvoid/avatars
      - /var/socialvoid/config/rpc_nginx.conf:/etc/nginx/nginx.conf:ro
      - /var/socialvoid/config/rpc_socialvoid.conf:/etc/nginx/http.d/socialvoid_rpc.conf:ro
      - /var/socialvoid/config/rpc_supervisord.conf:/etc/supervisord.conf:ro
      - /var/socialvoid/logs/rpc_nginx:/var/log/nginx
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "5200:5200"

  cdn_server:
    image: socialvoid_cdn:dockerfile
    container_name: socialvoid_cdn
    restart: always
    hostname: socialvoid_cdn
    networks:
      - master_socialvoid
    depends_on:
      gearman:
        condition: "service_started"
      redis:
        condition: "service_healthy"
      mysql_master:
        condition: "service_healthy"
      mysql_slave:
        condition: "service_healthy"
      telegram_bot_api:
        condition: "service_started"
      socialvoid:
        condition: "service_started"
    volumes:
      - /var/socialvoid/config/acm:/etc/acm
      - /var/socialvoid/lib:/var/socialvoid/lib
      - /var/socialvoid/legal:/var/socialvoid/legal
      - /var/socialvoid/avatars:/var/socialvoid/avatars
      - /var/socialvoid/config/cdn_nginx.conf:/etc/nginx/nginx.conf:ro
      - /var/socialvoid/config/cdn_socialvoid.conf:/etc/nginx/http.d/socialvoid_cdn.conf:ro
      - /var/socialvoid/config/cdn_supervisord.conf:/etc/supervisord.conf:ro
      - /var/socialvoid/logs/cdn_nginx:/var/log/nginx
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "5201:5201"

  mysql_master:
    image: mariadb:latest
    container_name: socialvoid_master_mysql
    hostname: master_mysql
    restart: unless-stopped
    networks:
      - master_socialvoid
    environment:
      MYSQL_DATABASE: socialvoid
      MARIADB_ALLOW_EMPTY_ROOT_PASSWORD: "yes"
      MYSQL_USER: socialvoid
      MYSQL_PASSWORD: socialvoid
      MYSQL_TCP_PORT: 3306
      MYSQL_ROOT_HOST: "%"
    volumes:
      - ./build/master.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      - /var/socialvoid/data/master_mysql:/var/lib/mysql
      - /var/socialvoid/data/backup_master_mysql:/backup
      - /var/socialvoid/config/master_mysql/my.cnf:/etc/mysql/my.cnf:ro
      - /var/socialvoid/config/master_mysql/mariadb.cnf:/etc/mysql/mariadb.cnf:ro
      - /var/socialvoid/config/master_mysql/mariadb.conf.d/50-client.cnf:/etc/mysql/mariadb.conf.d/50-client.cnf:ro
      - /var/socialvoid/config/master_mysql/mariadb.conf.d/50-mysql-clients.cnf:/etc/mysql/mariadb.conf.d/50-mysql-clients.cnf:ro
      - /var/socialvoid/config/master_mysql/mariadb.conf.d/50-mysqld_safe.cnf:/etc/mysql/mariadb.conf.d/50-mysqld_safe.cnf:ro
      - /var/socialvoid/config/master_mysql/mariadb.conf.d/50-server.cnf:/etc/mysql/mariadb.conf.d/50-server.cnf:ro
      - /var/socialvoid/config/master_mysql/mariadb.conf.d/60-galera.cnf:/etc/mysql/mariadb.conf.d/60-galera.cnf:ro
      - /var/socialvoid/config/master_mysql/mariadb.conf.d/99-enable-encryption.cnf.preset/enable_encryption.preset:/etc/mysql/mariadb.conf.d/99-enable-encryption.cnf.preset/enable_encryption.preset:ro
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "master_mysql"]
      timeout: 20s
      retries: 10

  mysql_slave:
    image: mariadb:latest
    container_name: socialvoid_slave_mysql
    hostname: slave_mysql
    restart: unless-stopped
    networks:
      - master_socialvoid
    environment:
      MYSQL_DATABASE: socialvoid
      MARIADB_ALLOW_EMPTY_ROOT_PASSWORD: "yes"
      MYSQL_USER: socialvoid
      MYSQL_PASSWORD: socialvoid
      MYSQL_TCP_PORT: 3306
      MYSQL_ROOT_HOST: "%"
    volumes:
      - ./build/slave.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      - /var/socialvoid/data/slave_mysql:/var/lib/mysql
      - /var/socialvoid/data/backup_slave_mysql:/backup
      - /var/socialvoid/config/slave_mysql/my.cnf:/etc/mysql/my.cnf:ro
      - /var/socialvoid/config/slave_mysql/mariadb.cnf:/etc/mysql/mariadb.cnf:ro
      - /var/socialvoid/config/slave_mysql/mariadb.conf.d/50-client.cnf:/etc/mysql/mariadb.conf.d/50-client.cnf:ro
      - /var/socialvoid/config/slave_mysql/mariadb.conf.d/50-mysql-clients.cnf:/etc/mysql/mariadb.conf.d/50-mysql-clients.cnf:ro
      - /var/socialvoid/config/slave_mysql/mariadb.conf.d/50-mysqld_safe.cnf:/etc/mysql/mariadb.conf.d/50-mysqld_safe.cnf:ro
      - /var/socialvoid/config/slave_mysql/mariadb.conf.d/50-server.cnf:/etc/mysql/mariadb.conf.d/50-server.cnf:ro
      - /var/socialvoid/config/slave_mysql/mariadb.conf.d/60-galera.cnf:/etc/mysql/mariadb.conf.d/60-galera.cnf:ro
      - /var/socialvoid/config/slave_mysql/mariadb.conf.d/99-enable-encryption.cnf.preset/enable_encryption.preset:/etc/mysql/mariadb.conf.d/99-enable-encryption.cnf.preset/enable_encryption.preset:ro
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "slave_mysql"]
      timeout: 20s
      retries: 10

  redis:
    image: redis:alpine
    container_name: socialvoid_redis
    hostname: redis
    networks:
      - master_socialvoid
    volumes:
      - /var/socialvoid/config/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]

  gearman:
    image: artefactual/gearmand:latest
    container_name: socialvoid_gearmand
    hostname: gearmand
    networks:
      - master_socialvoid
    environment:
      VERBOSE: ERROR

  telegram_bot_api:
    image: aiogram/telegram-bot-api:latest
    container_name: socialvoid_tdlib
    networks:
      - master_socialvoid
    environment:
      TELEGRAM_API_ID: "${TELEGRAM_API_ID}"
      TELEGRAM_API_HASH: "${TELEGRAM_API_HASH}"
      TELEGRAM_LOCAL: "1"
      TELEGRAM_STAT: "1"
    ports:
      - "5202:8081"
      - "5203:8082"
    volumes:
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro